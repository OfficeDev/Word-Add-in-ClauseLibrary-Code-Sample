/**
 @license $indexedDBProvider
 (c) 2014 Bram Whillock (bramski)
 Forked from original work by clements Capitan (webcss)
 License: MIT
 */
(function(){"use strict";var n=[].slice;angular.module("indexedDB",[]).provider("$indexedDB",function(){var u,c,e,l,r,t,i,f,a,o,s,v,h,y=this;s=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;u=window.IDBKeyRange||window.mozIDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;h=function(){function n(n){this.name=n;this.version=0;this.db=null;this.upgradesByVersion={};this.promise=null;this.transactions=[]}return n}();t={};i="";f={readonly:"readonly",readwrite:"readwrite"};v={pending:"pending"};r={next:"next",nextunique:"nextunique",prev:"prev",prevunique:"prevunique"};c={ascending:r.next,descending:r.prev};a={useIndex:void 0,keyRange:null,direction:r.next};l=function(n,r,u,f,e){for(var o in t[i].upgradesByVersion)!t[i].upgradesByVersion.hasOwnProperty(o)||o<=n||(e.log("$indexedDB: Running upgrade : "+o+" from "+n),t[i].upgradesByVersion[o](r,u,f))};o=function(n){return n.target.readyState===v.pending?"Error: Operation pending":n.target.webkitErrorMessage||n.target.error.message||n.target.errorCode};e=function(n,t){return t!==void 0?n.then(function(){return t}):n};this.connection=function(n){var r=t[n]?t[n]:t[n]=new h(n);return i=r.name,this};this.upgradeDatabase=function(n,r){return t[i].upgradesByVersion[n]=r,t[i].version=Math.max.apply(null,Object.keys(t[i].upgradesByVersion)),this};this.$get=["$q","$rootScope","$log",function(v,p,w){var nt,k,d,tt,rt,it,ut,ft,b,g,ot,et;return ot=function(n){return function(t){return p.$apply(function(){return n.reject(o(t))})}},ut=function(){var n,r,u;return r=v.defer(),u=t[i].version||1,n=s.open(t[i].name),n.onupgradeneeded=function(n){var r;t[i].db=n.target.result;r=n.target.transaction;w.log("$indexedDB: Upgrading database '"+t[i].db.name+"' from version "+n.oldVersion+" to version "+n.newVersion+" ...");l(n.oldVersion,n,t[i].db,r,w)},n.onsuccess=function(){t[i].db=n.result;p.$apply(function(){r.resolve(t[i].db)})},n.onblocked=function(n){console.log(n)},r.promise},b=function(){return t[i].promise||(t[i].promise=ut())},it=function(){return b().then(function(){return t[i].db.close(),t[i].db=null,t[i].promise=null})},et=function(n){var r,f,u,e;for(r=!0,u=0,e=n.length;u<e;u++)f=n[u],r=r&t[i].db.objectStoreNames.contains(f);return r},g=function(n,t){return t==null&&(t=f.readonly),b().then(function(){if(!et(n)){var i="Object stores "+n+" do not exist.";return console.error(i),v.reject(i)}return new tt(n,t)})},ft=function(n){if(n.beginKey&&n.endKey)return u.bound(n.beginKey,n.endKey)},rt=function(n){return t[i].transactions.push(n.promise),n.promise["finally"](function(){var r;return r=t[i].transactions.indexOf(n.promise),r>-1?t[i].transactions.splice(r,1):void 0})},tt=function(){function n(n,r){r==null&&(r=f.readonly);this.transaction=t[i].db.transaction(n,r);this.defer=v.defer();this.promise=this.defer.promise;this.setupCallbacks()}return n.prototype.setupCallbacks=function(){return this.transaction.oncomplete=function(n){return function(){return p.$apply(function(){return n.defer.resolve("Transaction Completed")})}}(this),this.transaction.onabort=function(n){return function(t){return p.$apply(function(){return n.defer.reject("Transaction Aborted",t)})}}(this),this.transaction.onerror=function(n){return function(t){return p.$apply(function(){return n.defer.reject("Transaction Error",t)})}}(this),rt(this)},n.prototype.objectStore=function(n){return this.transaction.objectStore(n)},n.prototype.abort=function(){return this.transaction.abort()},n}(),nt=function(){function t(){this.q=v.defer();this.promise=this.q.promise}return t.prototype.reject=function(){var t;return t=1<=arguments.length?n.call(arguments,0):[],p.$apply(function(n){return function(){var i;return(i=n.q).reject.apply(i,t)}}(this))},t.prototype.rejectWith=function(n){return n.onerror=n.onblocked=function(n){return function(t){return n.reject(o(t))}}(this)},t.prototype.resolve=function(){var t;return t=1<=arguments.length?n.call(arguments,0):[],p.$apply(function(n){return function(){var i;return(i=n.q).resolve.apply(i,t)}}(this))},t.prototype.notify=function(){var t;return t=1<=arguments.length?n.call(arguments,0):[],p.$apply(function(n){return function(){var i;return(i=n.q).notify.apply(i,t)}}(this))},t.prototype.dbErrorFunction=function(){return function(n){return function(t){return p.$apply(function(){return n.q.reject(o(t))})}}(this)},t.prototype.resolveWith=function(n){return this.rejectWith(n),n.onsuccess=function(n){return function(t){return n.resolve(t.target.result)}}(this)},t}(),k=function(){function n(n,t){this.storeName=n;this.store=t.objectStore(n);this.transaction=t}return n.prototype.defer=function(){return new nt},n.prototype._mapCursor=function(n,t,i){var r;return i==null&&(i=this.store.openCursor()),r=[],n.rejectWith(i),i.onsuccess=function(i){var u;return(u=i.target.result)?(r.push(t(u)),n.notify(t(u)),u["continue"]()):n.resolve(r)}},n.prototype._arrayOperation=function(n,t){var i,e,f,r,u,o;for(i=this.defer(),angular.isArray(n)||(n=[n]),u=0,o=n.length;u<o;u++)e=n[u],f=t(e),r=[],i.rejectWith(f),f.onsuccess=function(t){return r.push(t.target.result),i.notify(t.target.result),r.length>=n.length?i.resolve(r):void 0};return n.length===0?v.when([]):i.promise},n.prototype.getAllKeys=function(){var n,t;return n=this.defer(),this.store.getAllKeys?(t=this.store.getAllKeys(),n.resolveWith(t)):this._mapCursor(n,function(n){return n.key}),n.promise},n.prototype.clear=function(){var n,t;return n=this.defer(),t=this.store.clear(),n.resolveWith(t),n.promise},n.prototype["delete"]=function(n){var t;return t=this.defer(),t.resolveWith(this.store["delete"](n)),t.promise},n.prototype.upsert=function(n){return this._arrayOperation(n,function(n){return function(t){return n.store.put(t)}}(this))},n.prototype.insert=function(n){return this._arrayOperation(n,function(n){return function(t){return n.store.add(t)}}(this))},n.prototype.getAll=function(){var n;return n=this.defer(),this.store.getAll?n.resolveWith(this.store.getAll()):this._mapCursor(n,function(n){return n.value}),n.promise},n.prototype.eachWhere=function(n){var t,i,r,u,f;return t=this.defer(),r=n.indexName,u=n.keyRange,i=n.direction,f=r?this.store.index(r).openCursor(u,i):this.store.openCursor(u,i),this._mapCursor(t,function(n){return n.value},f),t.promise},n.prototype.findWhere=function(n){return this.eachWhere(n)},n.prototype.each=function(n){return n==null&&(n={}),this.eachBy(void 0,n)},n.prototype.eachBy=function(n,t){var i;return n==null&&(n=void 0),t==null&&(t={}),i=new d,i.indexName=n,i.keyRange=ft(t),i.direction=t.direction||a.direction,this.eachWhere(i)},n.prototype.count=function(){var n;return n=this.defer(),n.resolveWith(this.store.count()),n.promise},n.prototype.find=function(n){var t,i;return t=this.defer(),i=this.store.get(n),t.rejectWith(i),i.onsuccess=function(i){return function(r){return r.target.result?t.resolve(r.target.result):t.reject(""+i.storeName+":"+n+" not found.")}}(this),t.promise},n.prototype.findBy=function(n,t){var i;return i=this.defer(),i.resolveWith(this.store.index(n).get(t)),i.promise},n.prototype.query=function(){return new d},n}(),d=function(){function n(){this.indexName=void 0;this.keyRange=void 0;this.direction=r.next}return n.prototype.$lt=function(n){return this.keyRange=u.upperBound(n,!0),this},n.prototype.$gt=function(n){return this.keyRange=u.lowerBound(n,!0),this},n.prototype.$lte=function(n){return this.keyRange=u.upperBound(n),this},n.prototype.$gte=function(n){return this.keyRange=u.lowerBound(n),this},n.prototype.$eq=function(n){return this.keyRange=u.only(n),this},n.prototype.$between=function(n,t,i,r){return i==null&&(i=!1),r==null&&(r=!1),this.keyRange=u.bound(n,t,i,r),this},n.prototype.$desc=function(n){return this.direction=n?r.prevunique:r.prev,this},n.prototype.$asc=function(n){return this.direction=n?r.nextunique:r.next,this},n.prototype.$index=function(n){return this.indexName=n,this},n}(),{exists:function(n){return t[n]},connectionExists:function(){return i!=""&&i},open:function(n){var r=this.exists(n)?t[n]:t[n]=new h(n);return i=r.name,b()},connection:function(n){return y.connection(n)},getQuery:function(n,t,i){var r=new d;return r.indexName=n,r.direction="next",r[t](i)},openStore:function(n,t,i){return i==null&&(i=f.readwrite),g([n],i).then(function(i){var r;return r=t(new k(n,i)),e(i.promise,r)})},openStores:function(n,t,i){return i==null&&(i=f.readwrite),g(n,i).then(function(i){var r,u,f;return r=function(){var t,u,r;for(r=[],t=0,u=n.length;t<u;t++)f=n[t],r.push(new k(f,i));return r}(),u=t.apply(null,r),e(i.promise,u)})},openAllStores:function(n,r){return r==null&&(r=f.readwrite),b().then(function(){return function(){var o,s,h,u,f;return u=Array.prototype.slice.apply(t[i].db.objectStoreNames),f=new tt(u,r),o=function(){var n,i,t;for(t=[],n=0,i=u.length;n<i;n++)h=u[n],t.push(new k(h,f));return t}(),s=n.apply(null,o),e(f.promise,s)}}(this))},closeDatabase:function(){return it()},deleteDatabase:function(){return it().then(function(){var n;return n=new nt,n.resolveWith(s.deleteDatabase(t[i].name)),n.promise})["finally"](function(){return w.log("$indexedDB: "+t[i].name+" database deleted.")})},deleteAllDatabases:function(){var n=v.defer(),i=this;return async.forEachOf(t,function(n,t,r){i.connection(t);i.open(t).then(function(){i.deleteDatabase(t).then(function(){r()}).catch(function(n){console.error(n);r(n)})})},function(t){t?n.reject(t):n.resolve()}),n.promise},queryDirection:c,flush:function(){return t[i].transactions.length>0?v.all(t[i].transactions):v.when([])},databaseInfo:function(){return b().then(function(){var n,r;return r=null,n=Array.prototype.slice.apply(t[i].db.objectStoreNames),g(n,f.readonly).then(function(r){var u,f,e;return e=function(){var t,e,i;for(i=[],t=0,e=n.length;t<e;t++)f=n[t],u=r.objectStore(f),i.push({name:f,keyPath:u.keyPath,autoIncrement:u.autoIncrement,indices:Array.prototype.slice.apply(u.indexNames)});return i}(),r.promise.then(function(){return{name:t[i].db.name,version:t[i].db.version,objectStores:e}})})})}}}]})}).call(this);
//# sourceMappingURL=angular-indexed-db.min.js.map
